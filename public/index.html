<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Volunteer Clock Kiosk</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { height: 100%; }
    body { overflow: hidden; } /* âœ… prevents scrolling */
    .btn { -webkit-tap-highlight-color: transparent; }
    .pulse-soft { animation: pulseSoft 1.2s ease-in-out infinite; }
    @keyframes pulseSoft { 0%,100% { transform: scale(1); } 50% { transform: scale(1.02); } }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100">
  <!-- App shell locked to viewport -->
  <div class="h-[100svh] w-full flex flex-col">
    <!-- Top bar -->
    <header class="px-5 py-4 flex items-center justify-between">
      <div>
        <div class="text-2xl font-semibold tracking-tight">Volunteer Clock</div>
        <div id="subtitle" class="text-slate-300 text-sm mt-0.5">Step 1 of 3 â€” Scan or enter member number</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="homeBtn" class="btn px-4 py-3 rounded-2xl bg-slate-700/60 hover:bg-slate-700 border border-slate-600/60 text-base">
          Home
        </button>
        <button id="resetBtn" class="btn px-4 py-3 rounded-2xl bg-slate-700/60 hover:bg-slate-700 border border-slate-600/60 text-base">
          Reset
        </button>
      </div>
    </header>

    <!-- Progress -->
    <div class="px-5 pb-3">
      <div class="h-2 w-full rounded-full bg-slate-700/50 overflow-hidden">
        <div id="progressBar" class="h-2 w-1/3 bg-emerald-500"></div>
      </div>
    </div>

    <!-- Main -->
    <main class="flex-1 px-5 pb-5">
      <!-- STEP 1: Member -->
      <section id="step1" class="h-full">
        <div class="h-full grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Left: member entry -->
          <div class="h-full rounded-3xl bg-white/90 text-slate-900 border border-white/10 shadow-xl p-5 flex flex-col">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-semibold">Member</div>
                <div class="text-sm text-slate-600">Scan with handheld scanner or type using keypad.</div>
              </div>
              <div class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-800 text-sm">
                Ready
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-slate-700 mb-2">Member #</label>
              <div class="flex gap-2">
                <input id="memberInput" inputmode="numeric" autocomplete="off"
                       class="flex-1 px-5 py-4 rounded-2xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-900 text-slate-900 text-3xl tracking-wider"
                       placeholder="Scan or typeâ€¦" />
                <button id="lookupBtn"
                        class="btn px-6 py-4 rounded-2xl bg-slate-900 text-white hover:bg-slate-800 text-xl font-semibold">
                  Lookup
                </button>
              </div>

              <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                <button id="openKeypadBtn"
                        class="btn w-full px-6 py-5 rounded-3xl bg-slate-100 hover:bg-slate-200 border border-slate-200 text-slate-900 text-2xl font-semibold">
                  Open Keypad
                </button>

                <label class="w-full flex items-center justify-between gap-3 px-6 py-5 rounded-3xl bg-white border border-slate-200 text-slate-900 select-none">
                  <div>
                    <div class="text-base font-semibold leading-tight">Auto clock-out</div>
                    <div class="text-sm text-slate-600 leading-tight">If already clocked in, clock out then clock in.</div>
                  </div>
                  <input id="autoClockOutToggle" type="checkbox" checked class="w-6 h-6">
                </label>
              </div>

              <div class="mt-2 text-sm text-slate-600">
                Allowed: <b>1â€“4 digits</b>.
              </div>
            </div>

            <!-- Member card -->
            <div class="mt-4 rounded-3xl border border-slate-200 bg-white p-5">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="text-sm text-slate-500">Member</div>
                  <div id="memberName" class="text-2xl font-semibold text-slate-900">â€”</div>
                  <div id="memberMeta" class="text-sm text-slate-600 mt-1">Not loaded</div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-slate-500">Member #</div>
                  <div id="memberNum" class="text-5xl font-semibold text-slate-900">â€”</div>
                </div>
              </div>
            </div>

            <div class="mt-auto pt-4">
              <button id="toStep2Btn"
                      class="btn w-full py-5 rounded-3xl bg-emerald-600 hover:bg-emerald-500 text-white text-3xl font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
                Continue
              </button>
              <div class="mt-2 text-sm text-slate-600">
                Continue is enabled after a successful lookup.
              </div>
            </div>
          </div>

          <!-- Right: keypad (fixed height, no scroll) -->
          <div class="h-full rounded-3xl bg-white/90 text-slate-900 border border-white/10 shadow-xl p-5 flex flex-col">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">Keypad</div>
                <div class="text-sm text-slate-600">Touchscreen entry (optional)</div>
              </div>
              <button id="closeKeypadBtn"
                      class="btn px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 text-base">
                Hide
              </button>
            </div>

            <div id="keypadArea" class="mt-4 flex-1 hidden">
              <div class="grid grid-cols-3 gap-3 h-full content-start">
                <!-- Make buttons big but still fit -->
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="1">1</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="2">2</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="3">3</button>

                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="4">4</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="5">5</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="6">6</button>

                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="7">7</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="8">8</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="9">9</button>

                <button id="bkspBtn" class="btn py-6 rounded-2xl bg-slate-200 text-slate-900 text-2xl font-semibold border border-slate-300">âŒ«</button>
                <button class="btn key py-6 rounded-2xl bg-slate-900 text-white text-3xl font-semibold" data-k="0">0</button>
                <button id="clearBtn" class="btn py-6 rounded-2xl bg-slate-200 text-slate-900 text-2xl font-semibold border border-slate-300">Clear</button>

                <button id="enterBtn" class="btn col-span-3 py-6 rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white text-3xl font-semibold">
                  Enter / Lookup
                </button>
              </div>
            </div>

            <div id="keypadHint" class="mt-4 text-slate-700 text-base">
              Tap <b>Open Keypad</b> on the left to show it here, or just scan using the handheld scanner.
            </div>
          </div>
        </div>
      </section>

      <!-- STEP 2: Activity + actions -->
      <section id="step2" class="h-full hidden">
        <div class="h-full grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="h-full rounded-3xl bg-white/90 text-slate-900 border border-white/10 shadow-xl p-5 flex flex-col">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-lg font-semibold">Confirm Member</div>
                <div class="text-sm text-slate-600">If this isnâ€™t you, go back.</div>
              </div>
              <button id="backToStep1Btn"
                      class="btn px-5 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 text-base">
                Back
              </button>
            </div>

            <div class="mt-4 rounded-3xl border border-slate-200 bg-white p-5">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="text-sm text-slate-500">Member</div>
                  <div id="memberName2" class="text-3xl font-semibold text-slate-900">â€”</div>
                  <div id="memberMeta2" class="text-base text-slate-600 mt-1">â€”</div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-slate-500">Member #</div>
                  <div id="memberNum2" class="text-6xl font-semibold text-slate-900">â€”</div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-slate-700 mb-2">Select activity</label>
              <select id="activitySelect"
                      class="w-full px-5 py-5 rounded-2xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-900 text-slate-900 text-2xl bg-white">
                <option value="">Loadingâ€¦</option>
              </select>
              <div class="mt-2 text-sm text-slate-600">Only Active activities are shown.</div>
            </div>

            <div class="mt-auto pt-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button id="clockInBtn"
                        class="btn py-7 rounded-3xl bg-emerald-600 hover:bg-emerald-500 text-white text-4xl font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
                  Clock In
                </button>
                <button id="clockOutBtn"
                        class="btn py-7 rounded-3xl bg-indigo-600 hover:bg-indigo-500 text-white text-4xl font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
                  Clock Out
                </button>
              </div>
            </div>
          </div>

          <!-- Guidance panel (no scroll) -->
          <div class="h-full rounded-3xl bg-white/90 text-slate-900 border border-white/10 shadow-xl p-5 flex flex-col">
            <div class="text-lg font-semibold">Instructions</div>
            <div class="mt-2 text-base text-slate-700 leading-snug">
              <ul class="list-disc pl-5 space-y-2">
                <li>Choose the correct activity.</li>
                <li><b>Clock In</b> starts a shift for work-hour activities.</li>
                <li><b>Clock Out</b> closes your current open shift (if any).</li>
                <li>If youâ€™re already clocked in somewhere, youâ€™ll see a big warning.</li>
              </ul>
            </div>

            <div class="mt-auto pt-5">
              <div class="rounded-3xl border border-slate-200 bg-white p-4">
                <div class="text-sm text-slate-500">Auto clock-out</div>
                <div id="autoClockOutStatus" class="text-2xl font-semibold text-slate-900 mt-1">On</div>
                <div class="text-sm text-slate-600 mt-1">If already clocked in, the kiosk will clock you out first, then clock you in.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- STEP 3: Result screen -->
      <section id="step3" class="h-full hidden">
        <div id="resultCard"
             class="h-full rounded-3xl border border-white/10 shadow-xl p-6 flex flex-col items-center justify-center text-center bg-white/90 text-slate-900">
          <div id="resultTitle" class="text-5xl md:text-6xl font-extrabold tracking-tight">Done</div>
          <div id="resultSubtitle" class="mt-4 text-2xl md:text-3xl text-slate-700">â€”</div>

          <div id="resultDetails" class="mt-6 text-lg md:text-xl text-slate-600 max-w-3xl">
            â€”
          </div>

          <div class="mt-10 flex gap-3">
            <button id="resultHomeBtn"
                    class="btn px-8 py-5 rounded-3xl bg-slate-900 text-white hover:bg-slate-800 text-2xl font-semibold">
              Home
            </button>
            <button id="resultBackBtn"
                    class="btn px-8 py-5 rounded-3xl bg-slate-100 hover:bg-slate-200 border border-slate-200 text-slate-900 text-2xl font-semibold">
              Back
            </button>
          </div>

          <div id="autoReturnText" class="mt-6 text-base text-slate-500">
            Returning to Home automaticallyâ€¦
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ----------------------------
    // State
    // ----------------------------
    const state = {
      member: null,         // {id, number, name, phoneE164}
      activities: [],
      resetTimer: null,
      autoReturnTimer: null,
      keypadVisible: false,
    };

    const $ = (id) => document.getElementById(id);

    // ----------------------------
    // Step navigation (no scrolling)
    // ----------------------------
    function showStep(n) {
      const steps = [$("step1"), $("step2"), $("step3")];
      steps.forEach((el, i) => el.classList.toggle("hidden", i !== (n - 1)));

      const subtitle = $("subtitle");
      const bar = $("progressBar");

      if (n === 1) {
  subtitle.textContent = "Step 1 of 3 â€” Scan or enter member number";
  bar.className = "h-2 w-1/3 bg-emerald-500";

  // â± defer focus so DOM + Tailwind settle first
  setTimeout(() => focusMemberInput(false), 50);
}

      } else if (n === 2) {
        subtitle.textContent = "Step 2 of 3 â€” Choose activity and clock in/out";
        bar.className = "h-2 w-2/3 bg-emerald-500";
      } else {
        subtitle.textContent = "Step 3 of 3 â€” Result";
        bar.className = "h-2 w-full bg-emerald-500";
      }
    }

    // ----------------------------
    // Helpers
    // ----------------------------
    function onlyDigits1to4(s) {
      const t = String(s || "").trim();
      return /^\d{1,4}$/.test(t) ? t : null;
    }

    function focusMemberInput(select = true) {
      const inp = $("memberInput");
      inp.focus();
      if (select) inp.select();
    }

    function setMemberUI() {
      const m = state.member;
      $("memberName").textContent = m?.name || "â€”";
      $("memberMeta").textContent = m?.phoneE164 ? `Phone: ${m.phoneE164}` : (m ? "Phone: â€”" : "Not loaded");
      $("memberNum").textContent = m?.number ?? "â€”";

      $("memberName2").textContent = m?.name || "â€”";
      $("memberMeta2").textContent = m?.phoneE164 ? `Phone: ${m.phoneE164}` : "Phone: â€”";
      $("memberNum2").textContent = m?.number ?? "â€”";

      $("toStep2Btn").disabled = !m?.id;
      setButtonsEnabled();
      $("autoClockOutStatus").textContent = $("autoClockOutToggle").checked ? "On" : "Off";
    }

    function setButtonsEnabled() {
      const hasMember = !!state.member?.id;
      const activityId = $("activitySelect").value;
      $("clockInBtn").disabled = !(hasMember && activityId);
      $("clockOutBtn").disabled = !(hasMember);
    }

    function clearTimers() {
      if (state.resetTimer) clearTimeout(state.resetTimer);
      if (state.autoReturnTimer) clearTimeout(state.autoReturnTimer);
      state.resetTimer = null;
      state.autoReturnTimer = null;
    }

    function resetAll() {
      clearTimers();
      state.member = null;
      $("memberInput").value = "";
      $("activitySelect").value = "";
      setMemberUI();
      hideKeypad();
      showStep(1);
      
  // ðŸ” guarantee scanner focus after auto-reset
  setTimeout(() => focusMemberInput(false), 50);
    }

    function showResult({ kind, title, subtitle, details }) {
      // kind: success | warn | error
      const card = $("resultCard");
      const titleEl = $("resultTitle");
      const subEl = $("resultSubtitle");
      const detEl = $("resultDetails");

      titleEl.textContent = title || "Result";
      subEl.textContent = subtitle || "â€”";
      detEl.textContent = details || "";

      // loud colors without forcing custom palette everywhere
      card.className = "h-full rounded-3xl border border-white/10 shadow-xl p-6 flex flex-col items-center justify-center text-center bg-white/90 text-slate-900";
      if (kind === "success") {
        card.className += " ring-8 ring-emerald-300";
      } else if (kind === "warn") {
        card.className += " ring-8 ring-amber-300 pulse-soft";
      } else if (kind === "error") {
        card.className += " ring-8 ring-rose-300";
      }

      showStep(3);

      // auto return to home
      $("autoReturnText").textContent = "Returning to Home automaticallyâ€¦";
      if (state.autoReturnTimer) clearTimeout(state.autoReturnTimer);
      state.autoReturnTimer = setTimeout(() => {
        resetAll();
      }, 4500);
    }
// ðŸ”’ Always force focus back to Member # input (scanner safety)
document.addEventListener("click", () => {
  const step1Visible = !$("step1").classList.contains("hidden");
  if (step1Visible) focusMemberInput(false);
});

    // ----------------------------
    // Keypad
    // ----------------------------
    function showKeypad() {
      state.keypadVisible = true;
      $("keypadArea").classList.remove("hidden");
      $("keypadHint").classList.add("hidden");
    }
    function hideKeypad() {
      state.keypadVisible = false;
      $("keypadArea").classList.add("hidden");
      $("keypadHint").classList.remove("hidden");
    }
    function appendDigit(d) {
      const inp = $("memberInput");
      const cur = String(inp.value || "");
      if (cur.length >= 4) return;
      inp.value = cur + String(d);
      focusMemberInput(false);
    }
    function backspace() {
      const inp = $("memberInput");
      inp.value = String(inp.value || "").slice(0, -1);
      focusMemberInput(false);
    }
    function clearInput() {
      $("memberInput").value = "";
      focusMemberInput(false);
    }

    // ----------------------------
    // API calls
    // ----------------------------
    async function fetchActivities() {
      const r = await fetch("/api/activities");
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || "Failed to fetch activities");

      state.activities = data.activities || [];
      const select = $("activitySelect");
      select.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = state.activities.length ? "Choose an activityâ€¦" : "No active activities found";
      select.appendChild(placeholder);

      for (const a of state.activities) {
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = `${a.name} (${a.mode || "â€”"})`;
        select.appendChild(opt);
      }
    }

    async function lookupMemberByNumber(memberNumber) {
      const r = await fetch(`/api/member?number=${encodeURIComponent(memberNumber)}`);
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || "Member lookup failed");
      state.member = data.member;
      setMemberUI();
    }

    async function apiRecordClockIn(activityId) {
      const body = { memberId: state.member.id, memberNumber: Number(state.member.number), activityId };
      const r = await fetch("/api/record", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || "Clock in failed");
      return data;
    }

    async function apiSignOut() {
      const r = await fetch("/api/signout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ memberNumber: Number(state.member.number) })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || "Clock out failed");
      return data;
    }

    // ----------------------------
    // Flows
    // ----------------------------
    async function doLookup() {
      const memberNum = onlyDigits1to4($("memberInput").value);
      if (!memberNum) {
        showResult({ kind: "error", title: "Invalid Member #", subtitle: "Enter 1â€“4 digits", details: "Try scanning again or use the keypad." });
        return;
      }

      try {
        await lookupMemberByNumber(memberNum);
        showResult({ kind: "success", title: "Member Loaded", subtitle: `${state.member.name}`, details: `Member #${state.member.number}. Tap Home or Back to continue.` });
        // After showing a quick result, jump to Step 2 automatically
        if (state.autoReturnTimer) clearTimeout(state.autoReturnTimer);
        state.autoReturnTimer = setTimeout(() => {
          showStep(2);
        }, 1200);
      } catch (e) {
        showResult({
          kind: "error",
          title: "Member Not Eligible",
          subtitle: "Please see Khory",
          details: String(e.message || e)
        });
      }
    }

    async function clockInFlow() {
      const activityId = $("activitySelect").value;
      if (!state.member?.id) {
        showResult({ kind: "error", title: "No Member", subtitle: "Go back and scan", details: "You must load a member first." });
        return;
      }
      if (!activityId) {
        showResult({ kind: "error", title: "No Activity", subtitle: "Choose an activity", details: "Select an activity before Clock In." });
        return;
      }

      const autoClockOut = $("autoClockOutToggle").checked;

      try {
        const data1 = await apiRecordClockIn(activityId);

        if (data1.status === "shift_started") {
          showResult({ kind: "success", title: "Clocked In âœ…", subtitle: data1.activityName || "Activity", details: `Member #${state.member.number} â€” ${state.member.name}` });
          return;
        }

        if (data1.status === "attendance_recorded") {
          showResult({ kind: "success", title: "Attendance Recorded âœ…", subtitle: data1.activityName || "Activity", details: `Member #${state.member.number} â€” ${state.member.name}` });
          return;
        }

        if (data1.status === "already_open") {
          if (!autoClockOut) {
            showResult({
              kind: "warn",
              title: "Already Clocked In âš ï¸",
              subtitle: "Clock Out first (or enable Auto clock-out)",
              details: `Open shift started: ${data1.openSince || "earlier"}.`
            });
            return;
          }

          // Auto clock-out then try again
          const out = await apiSignOut();
          if (out.status !== "signed_out" && out.status !== "no_open_shift") {
            showResult({ kind: "error", title: "Auto Clock-Out Failed", subtitle: "Please see Khory", details: `Result: ${out.status}` });
            return;
          }

          const data2 = await apiRecordClockIn(activityId);
          if (data2.status === "shift_started") {
            showResult({ kind: "success", title: "Switched Activities âœ…", subtitle: data2.activityName || "Activity", details: "Auto clock-out complete, now clocked in." });
            return;
          }
          if (data2.status === "attendance_recorded") {
            showResult({ kind: "success", title: "Attendance Recorded âœ…", subtitle: data2.activityName || "Activity", details: "Auto clock-out complete." });
            return;
          }

          showResult({ kind: "error", title: "Still Open After Switch", subtitle: "Please see Khory", details: `Result: ${data2.status}` });
          return;
        }

        showResult({ kind: "warn", title: "Result", subtitle: String(data1.status), details: "If this looks wrong, please see Khory." });
      } catch (e) {
        showResult({ kind: "error", title: "Clock In Failed", subtitle: "Try again", details: String(e.message || e) });
      }
    }

    async function clockOutFlow() {
      if (!state.member?.number) {
        showResult({ kind: "error", title: "No Member", subtitle: "Go back and scan", details: "You must load a member first." });
        return;
      }

      try {
        const data = await apiSignOut();
        if (data.status === "signed_out") {
          showResult({ kind: "success", title: "Clocked Out âœ…", subtitle: "Shift closed", details: `Member #${state.member.number} â€” ${state.member.name}` });
          return;
        }
        if (data.status === "no_open_shift") {
          showResult({ kind: "warn", title: "No Open Shift", subtitle: "Nothing to clock out", details: "If you think you were clocked in, please see Khory." });
          return;
        }
        showResult({ kind: "warn", title: "Result", subtitle: String(data.status), details: "If this looks wrong, please see Khory." });
      } catch (e) {
        showResult({ kind: "error", title: "Clock Out Failed", subtitle: "Try again", details: String(e.message || e) });
      }
    }

    // ----------------------------
    // Wiring
    // ----------------------------
    $("lookupBtn").addEventListener("click", () => doLookup());
    $("memberInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); doLookup(); }
    });

    $("toStep2Btn").addEventListener("click", () => showStep(2));
    $("backToStep1Btn").addEventListener("click", () => showStep(1));

    $("activitySelect").addEventListener("change", () => setButtonsEnabled());
    $("autoClockOutToggle").addEventListener("change", () => setMemberUI());

    $("clockInBtn").addEventListener("click", () => clockInFlow());
    $("clockOutBtn").addEventListener("click", () => clockOutFlow());

    $("homeBtn").addEventListener("click", () => resetAll());
    $("resetBtn").addEventListener("click", () => resetAll());

    $("resultHomeBtn").addEventListener("click", () => resetAll());
    $("resultBackBtn").addEventListener("click", () => showStep(2));

    // keypad
    $("openKeypadBtn").addEventListener("click", () => { showKeypad(); focusMemberInput(false); });
    $("closeKeypadBtn").addEventListener("click", () => hideKeypad());
    $("bkspBtn").addEventListener("click", () => backspace());
    $("clearBtn").addEventListener("click", () => clearInput());
    $("enterBtn").addEventListener("click", () => doLookup());
    document.querySelectorAll(".key").forEach(btn => btn.addEventListener("click", () => appendDigit(btn.dataset.k)));

    // keep focus for scanners
    window.addEventListener("focus", () => focusMemberInput(false));

    // ----------------------------
    // Init
    // ----------------------------
    (async function init() {
      showStep(1);
      setMemberUI();
      setButtonsEnabled();
      hideKeypad();

      try {
        await fetchActivities();
        $("activitySelect").value = "";
      } catch (e) {
        // Keep UI usable even if activities fail
        $("activitySelect").innerHTML = `<option value="">Failed to load activities</option>`;
      }

      focusMemberInput(false);
    })();
  </script>
</body>
</html>
